@inherits AppComponentBase
@using System.Diagnostics
<SettingsField Label=@AppLocalization["CPU"]>
    @if (CPUCounter != null)
    {
        <MudText>@cpuUsage%</MudText>
    }
    else
    {
        <MudText>@AppLocalization["Loading"]</MudText>
    }

</SettingsField>
<SettingsField Label=@AppLocalization["Memory"]>
    @if (MemoryCounter != null)
    {
        <MudText>@memoryUsage</MudText>

    }
    else
    {
        <MudText>@AppLocalization["Loading"]</MudText>
    }
</SettingsField>

@code {
    [Parameter]
    public Process Process { get; set; }

    private string cpuUsage
    {
        get

        {
            var val = CPUCounter?.NextValue();
            if (val == null) return AppLocalization["Unable to read"];
            return Math.Round(val.Value, 2).ToString();


        }
    }
    private string memoryUsage
    {
        get

        {
            var val = MemoryCounter?.NextValue();
            if (val == null) return AppLocalization["Unable to read"];
            return new ByteSize(val.Value).ToString();


        }
    }
    private PerformanceCounter? CPUCounter;
    private PerformanceCounter? MemoryCounter;

    private Timer? refreshTimer;
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        refreshTimer = new Timer((state) => { InvokeAsync(StateHasChanged); }, null, 2000, 2000);
        await Task.Run(() =>
        {
            try
            {
                CPUCounter = new PerformanceCounter("Process", "% Processor Time",
                    Process.ProcessName);
                MemoryCounter = new PerformanceCounter("Process", "Working Set",
                                           Process.ProcessName);
            }
            catch (Exception ex)
            {
                Loggers.SystemLogger.Error("Error creating performance counters {@Error}", ex);
            }


        });

    }
    public override void Dispose()
    {
        refreshTimer?.Dispose();
    }
}