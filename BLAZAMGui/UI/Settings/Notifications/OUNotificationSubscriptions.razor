@inherits AppComponentBase

<MudSimpleTable>



    <tr>


        @foreach (var type in Enum.GetValues(typeof(NotificationType)))
        {
            var originalEnum = (NotificationType)type;
            <th class="align-self-center">
                @originalEnum.ToString()
            </th>
        }
        <th>
            @AppLocalization["In App"]
        </th>
        <th>
            @AppLocalization["To Email"]
        </th>
        <th>
            @AppLocalization["Block"]
        </th>
        <th>
            @AppLocalization["Save"]
        </th>
        <th>
            @AppLocalization["Delete"]
        </th>
    </tr>
    @if (subscriptions != null && subscriptions.Count > 0)
    {
        foreach (var sub in subscriptions)
        {
            <EditNotificationSubscriptionRow Subscription="sub"
                                             Context="Context"
                                             OnSaved="SaveExisting"
                                             OnDeleted="DeleteExisting" />

        }
    }
    <EditNotificationSubscriptionRow @bind-Subscription="newSubscription"
                                     Context="Context"
                                     OnAdded="AddSubscription" />



</MudSimpleTable>

<MudSimpleTable>

    <tr>
        <th colspan="10">
            @AppLocalization["Effective Notification Settings"]
        </th>

    </tr>
    <tr>

        @foreach (var type in Enum.GetValues(typeof(NotificationType)))
        {
            var originalEnum = (NotificationType)type;
            <th>
                @originalEnum.ToString()
            </th>
        }
        <th>
            @AppLocalization["In App"]
        </th>
        <th>
            @AppLocalization["To Email"]
        </th>
        <th>&nbsp;</th>
        <th>&nbsp;</th>
        <th>&nbsp;</th>

    </tr>

    <tr>
        @foreach (var type in Enum.GetValues(typeof(NotificationType)))
        {
            var originalEnum = (NotificationType)type;
            <td>
                @{

                }
                <MudCheckBox Style="align-items:center;"
                             Disabled=true
                             Value="@(effectiveInAppSubscription.NotificationTypes.FirstOrDefault(x=>x.NotificationType==originalEnum)!=null)" />


            </td>
        }

        <td>
            @{

            }
            <MudCheckBox Style="align-items:center;"
                         Disabled=true
                         Value="@(effectiveInAppSubscription.InApp)" />


        </td>
        <td>
            @{

            }
            <MudCheckBox Style="align-items:center;"
                         Disabled=true
                         Value="@(effectiveInAppSubscription.ByEmail)" />


        </td>

    </tr>


    <tr>
        @foreach (var type in Enum.GetValues(typeof(NotificationType)))
        {
            var originalEnum = (NotificationType)type;
            <td>
                @{

                }
                <MudCheckBox Style="align-items:center;"
                             Disabled=true
                             Value="@(effectiveByEmailSubscription.NotificationTypes.FirstOrDefault(x=>x.NotificationType==originalEnum)!=null)" />


            </td>
        }

        <td>
            @{

            }
            <MudCheckBox Style="align-items:center;"
                         Disabled=true
                         Value="@(effectiveByEmailSubscription.InApp)" />


        </td>
        <td>
            @{

            }
            <MudCheckBox Style="align-items:center;"
                         Disabled=true
                         Value="@(effectiveByEmailSubscription.ByEmail)" />


        </td>
    </tr>

</MudSimpleTable>

@code
{
    private IDirectoryEntryAdapter? _ou = null;
    [Parameter]
    public IDirectoryEntryAdapter? OU
    {
        get => _ou; set
        {
            if (_ou?.Equals(value) == true) return;
            _ou = value;
            ouChanged(_ou);
        }
    }

    [Parameter]
    public AppUser User { get; set; }


    NotificationSubscription newSubscription = new();
    NotificationSubscription effectiveInAppSubscription = new();
    NotificationSubscription effectiveByEmailSubscription = new();
    List<NotificationSubscription> subscriptions = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        UpdateSubscriptions();
    }

    private async void ouChanged(IDirectoryEntryAdapter entry)
    {
        var ou = (IADOrganizationalUnit)entry;
        if (ou != null)
        {
            if (User != null)
            {
                newSubscription.UserId = User.Id;
                newSubscription.OU = ou.DN;
                if (Context != null)
                    UpdateSubscriptions();
            }

        }
    }

    private void CalculateEffectiveSubscriptions()
    {
        effectiveInAppSubscription = new();
        effectiveInAppSubscription.OU = OU.DN;
        effectiveInAppSubscription.User = User;
        effectiveInAppSubscription.InApp = true;
        effectiveByEmailSubscription = new();
        effectiveByEmailSubscription.OU = OU.DN;
        effectiveByEmailSubscription.User = User;
        effectiveByEmailSubscription.ByEmail = true;
        var userSubscriptions = Context.NotificationSubscriptions.Where(x => x.DeletedAt == null && x.UserId == User.Id).ToList();
        userSubscriptions = userSubscriptions.OrderBy(x => x.OU).ToList();
        foreach (var sub in userSubscriptions)
        {
            if (OU.DN.Contains(sub.OU))
            {
                if (sub.Block)
                {
                    if (sub.InApp)
                    {
                        foreach (var type in sub.NotificationTypes)
                        {
                            effectiveInAppSubscription.NotificationTypes.RemoveAll(x => x.NotificationType == type.NotificationType);
                        }
                    }
                    if (sub.ByEmail)
                    {
                        foreach (var type in sub.NotificationTypes)
                        {
                            effectiveByEmailSubscription.NotificationTypes.RemoveAll(x => x.NotificationType == type.NotificationType);
                        }
                    }
                }
                else
                {
                    if (sub.InApp)
                    {
                        foreach (var type in sub.NotificationTypes)
                        {
                            if (!effectiveInAppSubscription.NotificationTypes.Any(x => x.NotificationType == type.NotificationType))
                            {
                                effectiveInAppSubscription.NotificationTypes.Add(new() { NotificationType = type.NotificationType });
                            }
                        }
                    }
                    if (sub.ByEmail)
                    {

                        foreach (var type in sub.NotificationTypes)
                        {
                            if (!effectiveByEmailSubscription.NotificationTypes.Any(x => x.NotificationType == type.NotificationType))
                            {
                                effectiveByEmailSubscription.NotificationTypes.Add(new() { NotificationType = type.NotificationType });
                            }
                        }
                    }


                }
            }
        }
    }
    private async void AddSubscription()
    {

        var changes = await Context.SaveChangesAsync();
        if (changes > 0)
        {
            newSubscription = new();
            SnackBarService.Success(AppLocalization["Saved notification subscription"]);
            UpdateSubscriptions();


        }
        else
        {
            SnackBarService.Warning(AppLocalization["Unable to save notification subscription"]);

        }

    }

    private async void SaveExisting()
    {
        var result = await Context.SaveChangesAsync();
        if (result > 0)
        {
            SnackBarService.Success("Subscription saved.");
            UpdateSubscriptions();
        }
        else
        {
            SnackBarService.Warning("Subscription could not be saved.");

        }
    }
    private async void DeleteExisting(NotificationSubscription subscription)
    {
        subscription.DeletedAt = DateTime.UtcNow;
        var result = await Context.SaveChangesAsync();
        if (result > 0)
        {
            SnackBarService.Success("Subscription deleted.");
        }
        else
        {
            SnackBarService.Warning("Subscription could not be deleted.");

        }
        UpdateSubscriptions();


    }
    private async void UpdateSubscriptions()
    {
        subscriptions = Context.NotificationSubscriptions.Include(x => x.NotificationTypes).Where(x => x.DeletedAt == null && x.UserId == User.Id && x.OU.Equals(OU.DN)).ToList();


        CalculateEffectiveSubscriptions();
        await InvokeAsync(StateHasChanged);
    }

}