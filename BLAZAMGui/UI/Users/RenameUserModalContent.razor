@inherits AppModalContent
@if (User != null && _privateUserInstance != null)
{
    <Section Title=@UserLocalization["Name"]>
        @if (User.CanReadField(ActiveDirectoryFields.GivenName))
        {
            <MudTextField Label="@UserLocalization["First Name"]" @bind-Value="@_privateUserInstance.GivenName" />



        }
        @if (User.CanReadField(ActiveDirectoryFields.MiddleName))
        {
            <MudTextField Label="@UserLocalization["Middle Name"]" @bind-Value="@_privateUserInstance.MiddleName" />



        }
        @if (User.CanReadField(ActiveDirectoryFields.SN))
        {
            <MudTextField Label="@UserLocalization["Last Name"]" @bind-Value="@_privateUserInstance.Surname" />



        }
        @if (User.CanReadField(ActiveDirectoryFields.DisplayName))
        {
            <MudTextField T="string" Label="@UserLocalization["Display Name"]" Text="@_privateUserInstance.DisplayName" TextChanged="DisplayNameChanged" />



        }


    </Section>
    @if (User.CanEditField(ActiveDirectoryFields.SAMAccountName))
    {


        <MudTextField Label="@UserLocalization["Username"]" @bind-Value="@_privateUserInstance.SamAccountName" />



    }
    @if (User.CanEditField(ActiveDirectoryFields.Mail))
    {


        <MudTextField Label="@UserLocalization["Email Address"]" @bind-Value="@_privateUserInstance.Email" />



    }
}
else
{
    <MudProgressCircular Indeterminate Color="Color.Primary" />
}
@code {

    #nullable disable warnings
    private IADUser _privateUserInstance;

    [Parameter]
    public EventCallback<IDirectoryEntryAdapter> DirectoryModelRenamed { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        _privateUserInstance = Directory.Users.FindUserBySID(User.SID.ToSidString());

        SaveDisabled = false;
        Modal.OnYes = SaveChanges;
        Modal.YesText = UserLocalization["Rename User"];
        Modal.Title = "Rename User";

        await InvokeAsync(StateHasChanged);
    }

    async Task DisplayNameChanged(string newName)
    {

        _privateUserInstance.DisplayName = newName;

    }
    async void SaveChanges()
    {
        var possibleConflictingMatch = Directory.Users.FindUsersByContainerName(_privateUserInstance.DisplayName, false, false);
        if (possibleConflictingMatch == null || possibleConflictingMatch.Equals(_privateUserInstance))
        {
            SaveDisabled = true;
            LoadingData = true;
            _privateUserInstance.Rename(_privateUserInstance.DisplayName);

            await _privateUserInstance.CommitChangesAsync();
            SnackBarService.Success("User has been renamed.", "User renamed");
            User.DirectoryEntry = null;

            DirectoryModelRenamed.InvokeAsync(_privateUserInstance);
            Close();
        }
        else
        {
            SnackBarService.Error("That name already exists. Please choose a different Display Name", "Name Exists");
        }
        LoadingData = false;

        SaveDisabled = false;
    }

}
