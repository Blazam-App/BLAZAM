@using BLAZAM.Database.Models.Templates;
@inherits DirectoryModelComponent

<MudElement Class="mx-auto">
    <MudForm @ref=@form Model="@User" @bind-IsValid=IsValid>



        @{
            if (IsAdmin)
            {
                <MudAlert Class="mud-alert-info">
                    All fields are editable because you are an admin.
                </MudAlert>
            }
        }

        @if (InDirectoryTemplate(ActiveDirectoryFields.Description) ||
        InDirectoryTemplate(ActiveDirectoryFields.Mail) ||
        InDirectoryTemplate(ActiveDirectoryFields.EmployeeId) ||
        InDirectoryTemplate(ActiveDirectoryFields.Department) ||
        InDirectoryTemplate(ActiveDirectoryFields.Company) ||
        InDirectoryTemplate(ActiveDirectoryFields.Title) ||
        InDirectoryTemplate(ActiveDirectoryFields.PhysicalDeliveryOffice)
        )
        {
            <Section Title=@AppLocalization["Organization"]>
                @if (InDirectoryTemplate(ActiveDirectoryFields.Description))
                {


                    <MudTextField Immediate=true
                                  Label="@AppLocalization["Description"]"
                                  @bind-Value=@User.Description
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.Description))
                                  Required=@(IsRequiredTemplateField(ActiveDirectoryFields.Description)) />




                }
                @if (InDirectoryTemplate(ActiveDirectoryFields.Mail))
                {
                    @if (DirectoryTemplate.EffectiveSendWelcomeEmail == true && DirectoryTemplate.EffectiveAskForAlternateEmail != true &&
                   (DirectoryTemplate.EffectiveFieldValues.Any(fv => fv.Field.Id == ActiveDirectoryFields.Mail.Id) && !DirectoryTemplate.EffectiveFieldValues.First(fv => fv.Field.Id == ActiveDirectoryFields.Mail.Id).Value.IsNullOrEmpty()))
                    {

                    }

                    <MudTextField Immediate=true
                                  Label="@AppLocalization["Email Address"]"
                                  @bind-Value="User.Email"
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.Mail))
                                  Required=@((DirectoryTemplate.EffectiveSendWelcomeEmail == true && DirectoryTemplate.EffectiveAskForAlternateEmail != true)||
                          IsRequiredTemplateField(ActiveDirectoryFields.Mail)) />




                }
                @if (InDirectoryTemplate(ActiveDirectoryFields.EmployeeId))
                {


                    <MudTextField Immediate=true
                                  Label="@AppLocalization["Employee Id"]"
                                  @bind-Value="@User.EmployeeId"
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.EmployeeId))
                                  Required=@(IsRequiredTemplateField(ActiveDirectoryFields.EmployeeId)) />




                }
                @if (InDirectoryTemplate(ActiveDirectoryFields.Department))
                {


                    <MudTextField Immediate=true
                                  Label="@AppLocalization["Department"]"
                                  @bind-Value="@User.Department"
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.Department))
                                  Required=@(IsRequiredTemplateField(ActiveDirectoryFields.Department)) />



                }
                @if (InDirectoryTemplate(ActiveDirectoryFields.Company))
                {


                    <MudTextField Immediate=true
                                  Label="@AppLocalization["Company"]"
                                  @bind-Value="@User.Company"
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.Company))
                                  Required=@(IsRequiredTemplateField(ActiveDirectoryFields.Company)) />




                }
                @if (InDirectoryTemplate(ActiveDirectoryFields.Title))
                {


                    <MudTextField Immediate=true
                                  Label="@AppLocalization["Job Title"]"
                                  @bind-Value="@User.Title"
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.Title))
                                  Required=@(IsRequiredTemplateField(ActiveDirectoryFields.Title)) />




                }
                @if (InDirectoryTemplate(ActiveDirectoryFields.PhysicalDeliveryOffice))
                {


                    <MudTextField Immediate=true
                                  Label="@AppLocalization["Office"]"
                                  @bind-Value="@User.PhysicalDeliveryOfficeName"
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.PhysicalDeliveryOffice))
                                  Required=@(IsRequiredTemplateField(ActiveDirectoryFields.PhysicalDeliveryOffice)) />




                }
            </Section>
        }

        @if (InDirectoryTemplate(ActiveDirectoryFields.HomePhone) ||
        InDirectoryTemplate(ActiveDirectoryFields.StreetAddress) ||
        InDirectoryTemplate(ActiveDirectoryFields.POBox) ||
        InDirectoryTemplate(ActiveDirectoryFields.City) ||
        InDirectoryTemplate(ActiveDirectoryFields.State) ||
        InDirectoryTemplate(ActiveDirectoryFields.PostalCode)
        )
        {
            <Section Title=@AppLocalization["Contact Info"]>

                @if (InDirectoryTemplate(ActiveDirectoryFields.HomePhone))
                {


                    <MudTextField Immediate=true
                                  Label="@AppLocalization["Home Phone"]"
                                  @bind-Value="@User.HomePhone"
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.HomePhone))
                                  Required=@(IsRequiredTemplateField(ActiveDirectoryFields.HomePhone)) />




                }
                @if (InDirectoryTemplate(ActiveDirectoryFields.StreetAddress))
                {


                    <MudTextField Immediate=true
                                  Label="@AppLocalization["Street Address"]"
                                  @bind-Value="@User.StreetAddress"
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.StreetAddress))
                                  Required=@(IsRequiredTemplateField(ActiveDirectoryFields.StreetAddress)) />




                }
                @if (InDirectoryTemplate(ActiveDirectoryFields.POBox))
                {


                    <MudTextField Immediate=true
                                  Label="@AppLocalization["Street"]"
                                  @bind-Value="@User.POBox"
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.POBox))
                                  Required=@(IsRequiredTemplateField(ActiveDirectoryFields.POBox)) />




                }
                @if (InDirectoryTemplate(ActiveDirectoryFields.City))
                {


                    <MudTextField Immediate=true
                                  Label="@AppLocalization["City"]"
                                  @bind-Value="@User.City"
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.City))
                                  Required=@(IsRequiredTemplateField(ActiveDirectoryFields.City)) />




                }
                @if (InDirectoryTemplate(ActiveDirectoryFields.State))
                {


                    <MudTextField Immediate=true
                                  Label="@AppLocalization["State"]"
                                  @bind-Value="@User.State"
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.State))
                                  Required=@(IsRequiredTemplateField(ActiveDirectoryFields.State)) />




                }
                @if (InDirectoryTemplate(ActiveDirectoryFields.PostalCode))
                {


                    <MudTextField Immediate=true
                                  Label="@AppLocalization["Zip Code"]"
                                  @bind-Value="@User.Zip"
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.PostalCode))
                                  Required=@(IsRequiredTemplateField(ActiveDirectoryFields.PostalCode)) />




                }
            </Section>
        }

        @if (InDirectoryTemplate(ActiveDirectoryFields.Site))
        {


            <MudTextField Immediate=true
                          Label="@AppLocalization["Site"]"
                          @bind-Value="@User.Site"
                          Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.Site))
                          Required=@(IsRequiredTemplateField(ActiveDirectoryFields.Site)) />




        }
        @if (InDirectoryTemplate(ActiveDirectoryFields.HomeDirectory) ||
        InDirectoryTemplate(ActiveDirectoryFields.HomeDrive) ||
        InDirectoryTemplate(ActiveDirectoryFields.ScriptPath) ||
        InDirectoryTemplate(ActiveDirectoryFields.ProfilePath)
        )
        {
            <Section Title=@AppLocalization["Profile"]>
                @if (InDirectoryTemplate(ActiveDirectoryFields.HomeDirectory))
                {


                    <MudTextField Immediate=true
                                  Label="@AppLocalization["Home Directory"]"
                                  @bind-Value="@User.HomeDirectory"
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.HomeDirectory))
                                  Required=@(IsRequiredTemplateField(ActiveDirectoryFields.HomeDirectory)) />




                }
                @if (InDirectoryTemplate(ActiveDirectoryFields.HomeDrive))
                {



                    <HomeDriveSelect Label="@AppLocalization["Home Drive"]"
                                     @bind-DriveLetter="@User.HomeDrive"
                                     Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.HomeDrive))
                                     Required=@(IsRequiredTemplateField(ActiveDirectoryFields.HomeDrive)) />




                }
                @if (InDirectoryTemplate(ActiveDirectoryFields.ScriptPath))
                {


                    <MudTextField Immediate=true
                                  Label="@AppLocalization["Script Path"]"
                                  @bind-Value="@User.ScriptPath"
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.ScriptPath))
                                  Required=@(IsRequiredTemplateField(ActiveDirectoryFields.ScriptPath)) />




                }
                @if (InDirectoryTemplate(ActiveDirectoryFields.ProfilePath))
                {


                    <MudTextField Immediate=true
                                  Label="@AppLocalization["Profile Path"]"
                                  @bind-Value="@User.ProfilePath"
                                  Disabled=@(!IsAdmin && !IsEditableTemplateField(ActiveDirectoryFields.ProfilePath))
                                  Required=@(IsRequiredTemplateField(ActiveDirectoryFields.Description)) />




                }
            </Section>
        }
        @if (User.CanReadAnyCustomFields)
        {
            <Section Title=@AppLocalization["Additional Fields"]>
                @foreach (var field in DirectoryTemplate.EffectiveFieldValues.Where(f => f.CustomField != null))
                {
                    @if (field.CustomField != null)
                    {
                        <MudTextField Immediate=true
                                      Validation=@(()=>{
                          if(field.Required && User.NewEntryProperties[field.CustomField.FieldName]!=null
                          && User.NewEntryProperties[field.CustomField.FieldName].ToString()!="")
                          return true;
                          else
                          return false;
                          })
                                      Label="@field.FieldDisplayName"
                                      @bind-Value="@User.NewEntryProperties[field.CustomField.FieldName]"
                                      Disabled=@(!IsAdmin && !IsEditableTemplateField(field.CustomField)) />
                    }
                }
            </Section>
        }




        <MudButton Color=Color.Success
                   Disabled=@(!IsValid)
                   OnClick="@(()=>{OnValidSubmit.InvokeAsync();})">Next</MudButton>




    </MudForm>
</MudElement>






@code {


#nullable disable warnings
    MudForm form;

    [Parameter]
    public DirectoryTemplate DirectoryTemplate { get; set; }
    [Parameter]
    public NewUserName NewUserName { get; set; }

    [Parameter]
    public bool IsValid { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        foreach (var fieldValue in DirectoryTemplate.EffectiveFieldValues)
        {
            try
            {
                if (fieldValue.Field != null && fieldValue.Value != null)
                    if (fieldValue.Field.FieldName.ToLower() == "homedirectory")
                        User.HomeDirectory = DirectoryTemplate.ReplaceVariables(fieldValue.Value, NewUserName, User.SamAccountName);
                    else
                        User.NewEntryProperties[fieldValue.Field.FieldName] = DirectoryTemplate.ReplaceVariables(fieldValue.Value, NewUserName, User.SamAccountName);
                else if (fieldValue.CustomField != null && fieldValue.Value != null)
                    User.NewEntryProperties[fieldValue.CustomField.FieldName] = DirectoryTemplate.ReplaceVariables(fieldValue.Value, NewUserName, User.SamAccountName);
            }
            catch (Exception ex)
            {
                Loggers.ActiveDirectoryLogger.Error("Could not set value for " + fieldValue.Field?.FieldName + ": " + fieldValue.Value?.ToString() + " {@Error}", ex);
            }

        }
    }

    bool InDirectoryTemplate(IActiveDirectoryField field)
    {
        return DirectoryTemplate.EffectiveFieldValues.Any(f => (f.Field != null && f.Field.FieldName == field.FieldName) || (f.CustomField != null && f.CustomField.FieldName == field.FieldName));
    }
    bool IsEditableTemplateField(IActiveDirectoryField field)
    {

        //if (IsAdmin) return true;

        if (field is ActiveDirectoryField)
            return DirectoryTemplate.EffectiveFieldValues.Any(f => f.Field.FieldName == field.FieldName && f.Editable);
        else
            return DirectoryTemplate.EffectiveFieldValues.Any(f => f.CustomField.FieldName == field.FieldName && f.Editable);

    }
    bool IsRequiredTemplateField(IActiveDirectoryField field)
    {


        if (field is ActiveDirectoryField)
            return DirectoryTemplate.EffectiveFieldValues.Any(f => f.Field.FieldName == field.FieldName && f.Required);
        else
            return DirectoryTemplate.EffectiveFieldValues.Any(f => f.CustomField.FieldName == field.FieldName && f.Required);
    }




}
