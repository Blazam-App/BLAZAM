@inherits SettingsComponents



<LoadingIndicator Height="Height.Is100" Visible=LoadingData>

        <MudText Typo ="Typo.h1">@SettingsLocalization["Email Settings"]</MudText>
        <MudForm @onsubmit="Save">

            <Validations Mode="ValidationMode.Auto" Model="@settings" StatusChanged="OnValidation">
                <SettingsField>
                    <MudFieldLabel>@SettingsLocalization["Email Enabled"]</FieldLabel>
                    
                        <MudSwitch @bind-Checked="settings.Enabled" />
                    
                </SettingsField>


                <Validation>
                    <SettingsField>
                        <MudFieldLabel>@SettingsLocalization["Admin bcc"]</FieldLabel>

                        <MudFieldHelp>
                            Addresses to blind copy all application emails that are sent.
                        </FieldHelp>
                        

                            <MudTextField  @bind-Value="settings.AdminBcc">
                                
                                    
                                
                            </MudTextField >
                        


                    </SettingsField>
                </Validation>

                <Validation>
                    <SettingsField>
                        <MudFieldLabel>@SettingsLocalization["SMTP Server"]</FieldLabel>
                        

                            <MudTextField  @bind-Value="settings.SMTPServer">
                                
                                    
                                
                            </MudTextField >
                        
                    </SettingsField>
                </Validation>
                <Validation>
                    <SettingsField>
                        <MudFieldLabel>@SettingsLocalization["SMTP Port"]</FieldLabel>
                        

                            <MudNumericField HideSpinButtons="true" @bind-Value="settings.SMTPPort">
                                
                                    
                                
                            </NumericEdit>
                        
                    </SettingsField>
                </Validation>
                <SettingsField>
                    <MudFieldLabel>@SettingsLocalization["Use TLS"]</FieldLabel>
                    
                        <MudSwitch TValue="bool" @bind-Checked="settings.UseTLS" />
                    
                </SettingsField>

                <SettingsField>
                    <MudFieldLabel>@SettingsLocalization["Use SMTP Authentication"]</FieldLabel>
                    
                        <MudSwitch TValue="bool" @bind-Checked="settings.UseSMTPAuth" />
                    
                </SettingsField>

                @if (settings.UseSMTPAuth)
                {
                    <Validation>
                        <SettingsField>
                            <MudFieldLabel>@SettingsLocalization["SMTP Username"]</FieldLabel>
                            
                                <MudTextField  @bind-Value="settings.SMTPUsername">
                                    
                                        
                                    
                                </MudTextField >
                            
                        </SettingsField>
                    </Validation>
                    <Validation>
                        <SettingsField>
                            <MudFieldLabel>@SettingsLocalization["SMTP Password"]</FieldLabel>
                            

                                <MudTextField  @bind-Value="settings.SMTPPassword">
                                    
                                        
                                    
                                </MudTextField >
                            
                        </SettingsField>
                    </Validation>
                }
                <Validation>
                    <SettingsField>
                        <MudFieldLabel>@SettingsLocalization["From Address"]</FieldLabel>
                        

                            <MudTextField  @bind-Value="settings.FromAddress">
                                
                                    
                                
                            </MudTextField >
                        
                    </SettingsField>
                </Validation>
                <Validation>
                    <SettingsField>
                        <MudFieldLabel>@SettingsLocalization["From Display Name"]</FieldLabel>
                        

                            <MudTextField  @bind-Value="settings.FromName">
                                
                                    
                                
                            </MudTextField >
                        
                    </SettingsField>
                </Validation>
                <Validation>
                    <SettingsField>
                        <MudFieldLabel>@SettingsLocalization["Reply-To Address"]</FieldLabel>
                        

                            <MudTextField  @bind-Value="settings.ReplyToAddress">
                                
                                    
                                
                            </MudTextField >
                        
                    </SettingsField>
                </Validation>
                <Validation>
                    <SettingsField>
                        <MudFieldLabel>@SettingsLocalization["Reply-To Display Name"]</FieldLabel>
                        

                            <MudTextField  @bind-Value="settings.ReplyToName">
                                
                                    
                                
                            </MudTextField >
                        
                    </SettingsField>
                </Validation>
                <Validations Model="testRecipient" StatusChanged="OnValidation">
                    <Validation Validator="ValidationRule.IsEmail">
                        <MudTextField  Disabled=@(!settings.Enabled) @bind-Value=testRecipient />
                        <MudButton Disabled=@(!settings.Enabled && !settings.Valid()) @onclick="SendTestEmail" Color="Color.Success">Send Test Email</MudButton>
                    </Validation>
                </Validations>

                <SettingsField>
                    
                        <MudButton Disabled="saveDisabled" Type="ButtonType.Submit" Color="Color.Success">Save Changes</MudButton>
                    
                </SettingsField>
            </Validations>
        </MudForm>
</LoadingIndicator>
@code {
#nullable disable warnings
    BLAZAM.Common.Models.Database.EmailSettings settings = new BLAZAM.Common.Models.Database.EmailSettings();
    string testRecipient;
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        if (Context != null)
        {
            originalSettings = await Context.EmailSettings.AsNoTracking().FirstOrDefaultAsync();
            var set = Context.EmailSettings.FirstOrDefault();

            if (set != null)
            {
                settings = set;
            }
        }

        LoadingData = false;
        await InvokeAsync(StateHasChanged);
    }
    async Task SendTestEmail()
    {
        try
        {
            await EmailService.SendTestEmail(testRecipient);
            await MessageService.Success("A test email was sent to " + testRecipient, "Test Email Sent");

        }
        catch (Exception ex)
        {
            await MessageService.Error(ex.Message, "Test Failed");
        }
    }
    protected override void Save()
    {
        if (settings.Id == 0 && Context!=null)
        {
            Context.EmailSettings.Add(settings);
        }
        AuditLogger.System.SettingsChanged("Email", settings.GetChanges(originalSettings));
        base.Save();

    }
}
