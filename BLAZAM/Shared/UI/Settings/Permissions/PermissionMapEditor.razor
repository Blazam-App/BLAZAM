@inherits ValidatedForm
@inject AppDatabaseFactory DbFactory
@if (Map != null)
{


    <MudForm @onsubmit="@Save">
            <MudField>
           @* <MudFieldLabel ColumnSize="ColumnSize.Is2.OnDesktop">@SettingsLocalization["User Groups"]</FieldLabel>
            <MudFieldBody ColumnSize="ColumnSize.Is10">
                    @if (!ReadOnly)
                        {


                            <Autocomplete TItem="PermissionDelegate"
                                  TValue="PermissionDelegate"
                                  FreeTyping=false
                                  MinLength=-1
                                  Data="@PermissionDelegates"
                                  TextField="@(( item ) => Directory.Groups.FindGroupBySID(item.DelegateSid)?.GroupName)"
                                  ValueField="@(( item ) => item)"
                                  Placeholder=@SettingsLocalization["Choose or Search..."]
                                  SelectionMode="AutocompleteSelectionMode.Checkbox"
                                  CloseOnSelection="false"
                                  @bind-SelectedValues="Map.PermissionDelegates"
                                  @bind-SelectedTexts="selectedPermissionDelegateNames" />
                            
                        }
                        else
                        {
                            @if (selectedPermissionDelegateNames != null)
                            {
                                @foreach (var name in selectedPermissionDelegateNames)
                                {
                                    <MudButton Disabled Width=Width.Auto Flex=Flex.InlineFlex Color="Color.Secondary">@name</MudButton>
                                }
                            }
                        }

*@
                
            </MudField>
            <MudField>
           @* <MudFieldLabel ColumnSize="ColumnSize.Is2.OnDesktop">@SettingsLocalization["Access Levels"]</FieldLabel>
            <MudFieldBody ColumnSize="ColumnSize.Is10">
                <Validation @ref=AccValidation Validator="ValidationRule.IsNotEmpty">
                    @if (!ReadOnly)
                        {
                            <Autocomplete TItem="AccessLevel"
                                  TValue="AccessLevel"
                                  FreeTyping=false
                                  MinLength=-1
                                  Data="@accessLevels"
                                  TextField="@(( item ) => item.Name)"
                                  ValueField="@(( item ) => item)"
                                  Placeholder=@SettingsLocalization["Choose or Search..."]
                                  SelectionMode="AutocompleteSelectionMode.Checkbox"
                                  CloseOnSelection="false"
                                  @bind-SelectedValues="Map.AccessLevels"
                                  @bind-SelectedTexts="selectedAccessLevelNames"
                                  Disabled=ReadOnly />
                        }
                        else
                        {
                            @if (selectedAccessLevelNames != null)
                            {
                                @foreach (var name in selectedAccessLevelNames)
                                {
                                    <MudButton Disabled Width=Width.Auto Flex=Flex.InlineFlex Color="Color.Secondary">@name</MudButton>
                                }
                            }
                        }

                        

                    </Validation>
*@
                
            </MudField>
            @if (!ReadOnly)
            {
                <MudButton Color=Color.Success Disabled=saveDisabled Type="ButtonType.Submit">Save Mapping</MudButton>
                <AppCloseButton Clicked="DeleteMapping" />
            }

    </MudForm>

    ValidateCheck();

}
@code {
#nullable disable warnings
    PermissionMapping? _map;
    [Parameter]
    public PermissionMapping? Map
    {
        get => _map; set
        {
            if (_map == value) return;

            _map = value;

            RefreshData();


        }
    }
    [Parameter]
    public EventCallback MappingDeleted{ get; set; }
    [Parameter]
    public bool ReadOnly { get; set; } = false;



    List<AccessLevel> accessLevels;
    List<PermissionDelegate> PermissionDelegates;
    List<string> selectedAccessLevelNames;
    List<string> selectedPermissionDelegateNames;
    protected override async Task OnInitializedAsync()
    {
        //Wait for a database connection
        await base.OnInitializedAsync();
       
        LoadingData = false;
        await RefreshData();
    }

    async Task RefreshData()
    {

        if (!LoadingData)
        {
            if (Map == null) return;

            LoadingData = true;

            if (Context != null)
            {
                if (Map.Id != 0)
                {
                    Map = Context.PermissionMap.Include(m => m.PermissionDelegates).Where(pm => pm.Id == Map.Id).FirstOrDefault();
                }
                accessLevels = await Context.AccessLevels.ToListAsync();
                PermissionDelegates = await Context.PermissionDelegate.Where(p => !p.IsSuperAdmin).ToListAsync();
                if (Map.Id != 0)
                {
                    selectedAccessLevelNames = Map.AccessLevels.Select(a => a.Name).ToList();
                    selectedPermissionDelegateNames = Map.PermissionDelegates.Select(
                        a => Directory.GetDirectoryModelBySid(a.DelegateSid).CanonicalName)
                        .ToList();
                }
                await InvokeAsync(StateHasChanged);
            }

        }
        LoadingData = false;

    }
    async Task DeleteMapping()
    {
        if (Map.Id == 0)
        {
            Map = null;
        }

        else
        {
            Context.PermissionMap.Remove(Map);
            await Context.SaveChangesAsync();
        }
        await InvokeAsync(StateHasChanged);
        await NotificationService.Success("Mapping deleted");
        await MappingDeleted.InvokeAsync();

    }
   new async Task Save()
    {
        if (Map.Id == 0)
            Context.PermissionMap.Add(Map);
        var result = Context.SaveChanges();
        await InvokeAsync(StateHasChanged);
        await NotificationService.Success("Mapping saved");

    }
    void ValidateCheck()
    {
        if (PrivValidation != null && AccValidation!=null && !ReadOnly)
        {
            if (Map != null)
            {
                if (Map.PermissionDelegates == null || Map.PermissionDelegates?.Count < 1)
                    PrivValidation.Status = ValidationStatus.Error;
                else
                    PrivValidation.Status = ValidationStatus.Success;
                if (Map.AccessLevels == null || Map.AccessLevels?.Count < 1)
                    AccValidation.Status = ValidationStatus.Error;
                else
                    AccValidation.Status = ValidationStatus.Success;
                if (AccValidation.Status == ValidationStatus.Success && PrivValidation.Status == ValidationStatus.Success)
                    saveDisabled = false;
                else
                    saveDisabled = true;
            }
        }
    }
}