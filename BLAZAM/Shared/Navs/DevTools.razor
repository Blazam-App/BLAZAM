@inherits AppComponentBase
@inject IHttpContextAccessor ca
<Accordion Border=Border.Is0.RoundedZero>
    <Collapse Border=Border.Is0.RoundedZero Visible="@collapseVisible">
        <CollapseHeader Border=Border.Is0.RoundedZero>
            <MudButton Border=Border.Is0.RoundedZero Background="Background.Dark"  style="height:15px;" Clicked="@(()=>collapseVisible = !collapseVisible)">Dev Tools</MudButton>

        </CollapseHeader>
        <CollapseBody>
            <Row>
                <MudButton Border=Border.Is0.RoundedZero Background="Background.Dark"  style="height:35px;" Clicked="@(()=>{NotificationService.Success("Test Notification " + Guid.NewGuid(),"Test");})">Test Notification</MudButton>
                <MudButton Border=Border.Is0.RoundedZero Background="Background.Dark"  style="height:35px;" Clicked="@(()=>{NotificationBroadcast.Success("Test Broadcast " + Guid.NewGuid(),"Test");})">Test Broadcast</MudButton>

                <MudCard ColumnSize="ColumnSize.Is3.OnFullHD.Is6.OnDesktop">
                    <MudCardHeader>
                        Conn Monitor
                    </MudCardHeader>
                    <MudCardBody>
                        <Row>Database Status: @Enum.GetName(typeof(ServiceConnectionState),Monitor.DatabaseConnected)</Row>
                        <Row>ActiveDirectory Status: @Enum.GetName(typeof(ServiceConnectionState),Monitor.DirectoryConnected)</Row>
                        <Row>App Ready Status: @Enum.GetName(typeof(ServiceConnectionState),Monitor.AppReady)</Row>
                        <Row>Error Message: @Oops.ErrorMessage</Row>
                    </MudCardBody>
                </MudCard>
                <MudCard ColumnSize="ColumnSize.Is3.OnFullHD.Is6.OnDesktop">
                    <MudCardHeader>
                        User State Service
                    </MudCardHeader>
                    <MudCardBody>
                        <Row>User States: @UserStateService.UserStates.Count</Row>
                        @foreach (var state in UserStateService.UserStates)
                        {
                            <MudCard>
                                <Row>Username: @state.User?.Identity?.Name</Row>
                                <Row>Authenticated: @state.User?.Identity?.IsAuthenticated</Row>
                                <Row>Auth Type: @state.User?.Identity?.AuthenticationType</Row>
                                <Row>Last Access: @state.LastAccessed</Row>
                                <Row>Ticket Expiration: @(state.Ticket?.Properties.ExpiresUtc)</Row>
                                <Row>Is Super Admin: @state.IsSuperAdmin</Row>
                                <Row>Directory Entry Exists: @(state.DirectoryUser != null)</Row>
                                    @if (state.DirectoryUser != null)
                                {
                                    <Row>Has User Priv: @state.DirectoryUser.HasUserPrivilege</Row>
                                    <Row>Has Group Priv: @state.DirectoryUser.HasGroupPrivilege</Row>
                                    <Row>Has OU Priv: @state.DirectoryUser.HasOUPrivilege</Row>
                                    <Row>Has Computer Priv: @state.DirectoryUser.HasComputerPrivilege</Row>

                                }
                            </MudCard>


                        }
                    </MudCardBody>
                </MudCard>


                <MudCard ColumnSize="ColumnSize.Is3.OnFullHD.Is6.OnDesktop">
                    <MudCardHeader>
                        User
                    </MudCardHeader>
                    <MudCardBody>
                        @{
                            var ids = ca.HttpContext?.User.Identities.ToList();
                        }
                        @if (ids != null)
                        {
                            @foreach (var id in ids)
                            {

                                var claims2 = @ca.HttpContext?.User.Claims.ToList();

                                <Row>Name: @id.Name</Row>
                                <Row>Authenticated: @id.IsAuthenticated.ToString()</Row>
                                <Row>Type: @id.AuthenticationType</Row>
                                @if (claims2 != null)
                                {
                                    @foreach (var claim in claims2)
                                    {
                                        <Row>@claim.Type: @claim.Value</Row>

                                    }
                                }
                            }
                        }
                    </MudCardBody>
                </MudCard>



                <MudCard ColumnSize="ColumnSize.Is3.OnFullHD.Is6.OnDesktop">
                    <MudCardHeader>
                        Active Directory
                    </MudCardHeader>
                    <MudCardBody>
                        <Row>
                            <Row>ActiveDirectory Status: @DirectoryStatus</Row>
                            <Row>ActiveDirectory Server: @Directory.ConnectionSettings?.ServerAddress</Row>
                            <Row>ActiveDirectory Server Pingable: @DirectoryPingable</Row>

                            <Row>ActiveDirectory Server Port: @Directory.ConnectionSettings?.ServerPort</Row>
                            <Row>ActiveDirectory Server Port Open: @DirectoryPortOpen</Row>

                        </Row>
                    </MudCardBody>
                </MudCard>

            </Row>
        </CollapseBody>
    </Collapse>

</Accordion>


@code {
    string DirectoryStatus = "";
    bool DirectoryPingable;
    bool DirectoryPortOpen;
    bool collapseVisible = false;
    Timer t;
    protected override void OnInitialized()
    {
        base.OnInitialized();
        t = new Timer((obj) =>
        {
            DirectoryPingable = Directory.Pingable;
            DirectoryPortOpen = Directory.PortOpen;
            DirectoryStatus = Enum.GetName(typeof(DirectoryConnectionStatus), Directory.Status);
            InvokeAsync(StateHasChanged);
        }, null, 500, 2000);
    }

}