@inherits LayoutComponentBase
@using BLAZAM.Server.Background;
@using BLAZAM.Server.Data;
@using BLAZAM.Server.Errors.ActiveDirectory;
@using BLAZAM.Server.Errors.Database;
@using Microsoft.EntityFrameworkCore
@using System.DirectoryServices
@inject NavigationManager Nav
@inject IActiveDirectory directory
@inject IApplicationUserStateService UserStateService
@inject IDbContextFactory<DatabaseContext> DbFactory
@inject ConnMonitor monitor
<PageTitle>BLAZAM</PageTitle>

<Layout Sider>
    <AuthorizeView Context="authContext">
        <Authorized>
            <LayoutSider>
                <LayoutSiderContent>
                    <NavMenu />
                </LayoutSiderContent>
            </LayoutSider>

            <Layout Background="Background.Light" TextColor="TextColor.Dark">

                <LayoutHeader Fixed>

                    @if (setHeader != null)
                    {
                        @setHeader.ChildContent

                    }
                    else
                    {
                        <CascadingValue Value="SearchTerm">
                            <CascadingValue Value="this">
                                <SearchPageHeader OnSubmit=SubmitSearch Text="Search">
                                    <ADAutoComplete @bind-SearchTerm="@SearchTerm" @bind-SearchDisabled=@SearchDisabledObjects />
                                </SearchPageHeader>
                            </CascadingValue>
                        </CascadingValue>
                    }
                    @if (setSubHeader != null)
                    {
                        @setSubHeader.ChildContent

                    }
                </LayoutHeader>
                <LayoutContent Style="height: 100vh;overflow: auto;">

                    <CascadingValue Value="this">
                        @Body
                    </CascadingValue>

                </LayoutContent>
                <LayoutFooter>
                    <AppFooter />
                    <AuthorizeView Context="authorizedContext" Roles=@UserRoles.SuperAdmin>
                        @if (Program.InDebugMode)
                        {
                            <DevTools />
                        }
                    </AuthorizeView>
                </LayoutFooter>
            </Layout>
            <NotificationBroadcastListener />
        </Authorized>
        <NotAuthorized>
            <Layout>
                <LayoutContent Style="height: 100vh;overflow: auto;">
                    <CascadingValue Value="this">
                        @Body
                    </CascadingValue>
                </LayoutContent>
            </Layout>
        </NotAuthorized>
    </AuthorizeView>

</Layout>
@code {
    string _searchTerm;
    /// <summary>
    /// The search term that comes from the search text box
    /// </summary>
    public string? SearchTerm { get=>_searchTerm; set
        {
            if (_searchTerm == value) return;
            _searchTerm = value;
            InvokeAsync(StateHasChanged);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        SearchDisabledObjects = UserStateService?.CurrentUserState?.UserSettings?.SearchDisabledUsers == true;

    }

    SetHeader? setHeader;
    public void SetHeader(SetHeader? setHeader)
    {
        this.setHeader = (setHeader);
        if (setHeader != null)

            this.setHeader.OnRefreshRequested += (() => { InvokeAsync(StateHasChanged); });

        //StateHasChanged();
        InvokeAsync(StateHasChanged);
        //Update();
    }
    SetSubHeader? setSubHeader;
    public void SetSubHeader(SetSubHeader? setSubHeader)
    {
        this.setSubHeader = (setSubHeader);
        if (setSubHeader != null)
            this.setSubHeader.OnRefreshRequested += (() => { InvokeAsync(StateHasChanged); });

        //StateHasChanged();
        InvokeAsync(StateHasChanged);
        //Update();
    }

    public void Update() => StateHasChanged();
    public async Task SubmitSearch() => await SubmitSearch(null);
    public async Task SubmitSearch(string? searchTerm = null)
    {
        if (searchTerm != null)
            SearchTerm = searchTerm;


        Nav.NavigateTo("/search/" + SearchTerm);


        //Search();

        InvokeAsync(StateHasChanged);
    }

    bool _searchDisabledObjects;
    /// <summary>
    /// Indicates whether to search for disabled
    /// Active Diretory Entries
    /// </summary>
    public bool SearchDisabledObjects
    {
        get => _searchDisabledObjects; set
        {
            if (_searchDisabledObjects == value) return;
            _searchDisabledObjects = value;
            InvokeAsync(StateHasChanged);

        }
    }

}