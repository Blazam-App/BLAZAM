@inherits AppComponentBase

@{
    if (CurrentUserState == null)
    {
        GetCurrentUser();

    }
}

@if (CurrentUserState?.UserSettings?.ProfilePicture != null)
{
    <Base64Image Elevation="4" Class="  mud-border-secondary border-2 mud-avatar mud-avatar-medium" Data="@CurrentUserState.UserSettings?.ProfilePicture" />

}
else
{
    <MudAvatar Elevation="4" Style="@AvatarColor">@UserStateService.CurrentUsername?.FirstOrDefault()</MudAvatar>

}



@code {
    IApplicationUserState? CurrentUserState;
    string AvatarColor
    {
        get
        {
            if (CurrentUserState?.Username.IsNullOrEmpty() == true) return "background-color:#0c13a7";
            int usernameHash = CurrentUserState.Username.GetAppHashCode();
            byte[] usernameHashBytes = usernameHash.ToByteArray(3);
            string hexColor = "background-color:#";
            hexColor += Convert.ToHexString(usernameHashBytes.Take(3).ToArray());
            return hexColor;

        }
    }
    protected override void OnInitialized()
    {
        base.OnInitialized();
        GetCurrentUser();
    }
    void GetCurrentUser()
    {
        CurrentUserState = UserStateService.CurrentUserState;
        CurrentUserState.OnSettingsChange = ((settings) =>
        {
            InvokeAsync(StateHasChanged);
        });
    }

}