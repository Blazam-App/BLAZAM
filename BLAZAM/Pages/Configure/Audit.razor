@page "/audit"
@page "/audit/{ActiveTab}"

@attribute [Authorize(Roles = UserRoles.SuperAdmin)]
@inherits TabbedAppComponentBase






<AppPageTitle>Audit</AppPageTitle>
<h3>Audit</h3>



<MudTabs ActivePanelIndex="@ActiveTab">
    <MudTabPanel>
        <ChildContent>
            <MudDataGrid Virtualize  ColumnResizeMode="ResizeMode.Container"   Hideable Items="@auditEntries.OrderByDescending(ae=>ae.Timestamp)" Filterable="false" SortMode="@SortMode.Multiple" Groupable="false">
                <Columns>
                    <PropertyColumn Property="x => x.Timestamp" />
                    <PropertyColumn Property="x => x.Username" />
                    <PropertyColumn Property="x => x.IpAddress"  />
                    <PropertyColumn Property="x => x.Action" />
                    <PropertyColumn Property="x => x.Target"/>
                    <PropertyColumn Property="x => x.BeforeAction"/>
                    <PropertyColumn Property="x => x.AfterAction"/>
                   
                </Columns>
            </MudDataGrid>


         

        </ChildContent>
        <TabContent>
            @SettingsLocalization["User"]
        </TabContent>
    </MudTabPanel>
    <MudTabPanel>
        <ChildContent>
                <MudDataGrid Virtualize ColumnResizeMode="ResizeMode.Container" Hideable Items="@systemAuditEntries.OrderByDescending(ae=>ae.Timestamp)" Filterable="false" SortMode="@SortMode.Multiple" Groupable="false">
                <Columns>
                    <PropertyColumn Property="x => x.Timestamp" />
                    <PropertyColumn Property="x => x.Username" />
                    <PropertyColumn Property="x => x.IpAddress" />
                    <PropertyColumn Property="x => x.Action" />
                    <PropertyColumn Property="x => x.Target" />
                    <PropertyColumn Property="x => x.BeforeAction" />
                    <PropertyColumn Property="x => x.AfterAction" />

                </Columns>
                </MudDataGrid>

           

        </ChildContent>
        <TabContent>
            @SettingsLocalization["System"]
        </TabContent>


    </MudTabPanel>
   
</MudTabs>


@code {
    List<CommonAuditLog> auditEntries = new();
    List<SystemAuditLog> systemAuditEntries = new();

    protected override async Task OnInitializedAsync()
    {


        await base.OnInitializedAsync();
        BaseUri = "/audit";
        using (var context = await DbFactory.CreateDbContextAsync())
        {
            auditEntries = await context.LogonAuditLog.ToListAsync<CommonAuditLog>();
            auditEntries.AddRange(context.UserAuditLog.ToList<CommonAuditLog>());
            auditEntries.AddRange(context.GroupAuditLog.ToList<CommonAuditLog>());
            auditEntries.AddRange(context.OUAuditLog.ToList<CommonAuditLog>());
            auditEntries.AddRange(context.ComputerAuditLog.ToList<CommonAuditLog>());

            systemAuditEntries = await context.SystemAuditLog.ToListAsync();
        }
    }
}
