@page "/templates"
@page "/templates/{TemplateIdParameter:int}"
@inherits TemplateComponent
@attribute [Authorize(Roles = UserRoles.SuperAdmin)]

<AppPageTitle>Templates</AppPageTitle>

<SetHeader @ref=Header>


    <MudStack Row=true>
        <MudText>
            Templates

        </MudText>

        <MudSelectList T="string"
                       Label="Category"
                       Values="TemplateCategories"
                       @bind-Value="@SelectedCategory" />

        <MudSelectList T="DirectoryTemplate"
                       Disabled=@(Templates.Count()<1)
                       Label="Template"
                       Values="@Templates"
                       Value="@SelectedTemplate"
                       ValueChanged="@((selected)=>{
                                        SelectedTemplate = selected;
                                        Nav.NavigateTo("/templates/"+selected.Id);
                                        })" />

        <MudTooltip Color=Color.Error
                    ShowOnHover=@(Templates?.Count() < 1)
                    Arrow=true
                    IsVisible=@(createFirstTemplateTooltipVisible)
                    Text="Create your first template">

            <MudIconButton Color=Color.Tertiary
                           Class="align-middle"
                           OnClick="@(()=>{SelectedTemplate = new();Nav.NavigateTo("/templates");})"
                           Icon="@Icons.Material.Filled.AddCard" />

        </MudTooltip>



        @if (SelectedCategory != null && SelectedCategory != "All")
        {
            <MudButton OnClick=@(()=>{RenameModal?.Show();})
                   Color="Color.Tertiary"
                   StartIcon="@Icons.Material.Filled.ChangeCircle" />
        }
        @if (SelectedTemplate != null)
        {
            <MudButton OnClick=@(async()=>{await DuplicateTemplate(SelectedTemplate);}) Color="Color.Tertiary" StartIcon="@Icons.Material.Filled.FileCopy" />
        }


    </MudStack>

    <AppModal @ref=RenameModal Title="Rename Category">


        <MudTextField Label="New Name" @bind-Value=newCategoryName />


        <MudButton Color="Color.Primary" OnClick="RenameSelectedCategory">Save</MudButton>
    </AppModal>
</SetHeader>
@if (SelectedTemplate != null)
{
    <EditDirectoryTemplate Header="Header" DirectoryTemplate=@SelectedTemplate />
}




@code {
    bool createFirstTemplateTooltipVisible;
    AppModal? RenameModal;
    string? newCategoryName;
    protected async Task DuplicateTemplate(DirectoryTemplate template)
    {
        SelectedTemplate = (DirectoryTemplate)template.Clone();
        await RefreshComponents();


    }
    async Task RenameSelectedCategory()
    {
        var temp = Context?.DirectoryTemplates.Where(t => t.Category == SelectedCategory).ToList();
        foreach (var template in temp)
        {
            template.Category = newCategoryName;
        }
        if (SelectedTemplate.Category == SelectedCategory)
            SelectedTemplate.Category = newCategoryName;
        Context?.SaveChanges();

        SnackBarService.Success("Renamed category " + SelectedCategory + " to " + newCategoryName);
        SelectedCategory = newCategoryName;
        await FetchTemplates();
        RenameModal?.Hide();
        await RefreshComponents();

    }
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await RefreshComponents();
        if (Templates?.Count() < 1)
        {

            await Task.Delay(1000);
            createFirstTemplateTooltipVisible = true;
            await RefreshComponents();



        }
    }
}
